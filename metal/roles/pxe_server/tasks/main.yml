- name: Download x86_64 boot image
  ansible.builtin.get_url:
    url: "{{ iso_x86_64_url }}"
    dest: "{{ role_path }}/files/data/iso/x86_64/{{ iso_x86_64_url | basename }}"
    checksum: "{{ iso_x86_64_checksum }}"
    mode: 0644
  register: iso_x86_64

- name: Download aarch64 boot image
  ansible.builtin.get_url:
    url: "{{ iso_aarch64_url }}"
    dest: "{{ role_path }}/files/data/iso/aarch64/{{ iso_aarch64_url | basename }}"
    checksum: "{{ iso_aarch64_checksum }}"
    mode: 0644
  register: iso_aarch64

- name: Download rpi4 uefi firmware
  ansible.builtin.get_url:
    url: "{{ rpi4_uefi_firmware_url }}"
    dest: "{{ role_path }}/files/data/iso/aarch64/{{ rpi4_uefi_firmware_url | basename }}"
    #checksum: "{{ rpi4_uefi_firmware_checksum }}"
    mode: 0644
  register: rpi4_uefi_firmware

- name: Extract rpi4 uefi firmware
  ansible.builtin.command:
    cmd: "unzip {{ rpi4_uefi_firmware.dest }} -d {{ role_path }}/files/data/os/rpi4_uefi_firmware"
    creates: "{{ role_path }}/files/data/os/rpi4_uefi_firmware/config.txt"

- name: Extract x86_64 boot image
  ansible.builtin.command:
    cmd: "xorriso -osirrox on -indev {{ iso_x86_64.dest }} -extract / {{ role_path }}/files/data/os/x86_64"
    creates: "{{ role_path }}/files/data/os/x86_64/.treeinfo"

- name: Extract aarch64 boot image
  ansible.builtin.command:
    cmd: "xorriso -osirrox on -indev {{ iso_aarch64.dest }} -extract / {{ role_path }}/files/data/os/aarch64"
    creates: "{{ role_path }}/files/data/os/aarch64/.treeinfo"

- name: Copy rpi4 firmware
  ansible.builtin.copy:
    src: "{{ role_path }}/files/data/os/rpi4_uefi_firmware/"
    dest: "{{ role_path }}/files/data/os/tftp/"
    mode: 0644

- name: Generate dnsmasq config
  ansible.builtin.template:
    src: dnsmasq.conf.j2
    dest: "{{ role_path }}/files/data/pxe-config/dnsmasq.conf"
    mode: 0644

- name: Generate x86_64 GRUB config
  ansible.builtin.template:
    src: grub_x86_64.cfg.j2
    dest: "{{ role_path }}/files/data/os/tftp/x86_64/grub.cfg"
    mode: 0644

- name: Generate aarch64 GRUB config
  ansible.builtin.template:
    src: grub_aarch64.cfg.j2
    dest: "{{ role_path }}/files/data/os/tftp/aarch64/grub.cfg"
    mode: 0644

- name: Generate init config for each machine
  ansible.builtin.template:
    src: kickstart.ks.j2
    dest: "{{ role_path }}/files/data/init-config/{{ hostvars[item]['mac'] }}.ks"
    mode: 0644
  loop: "{{ groups['metal'] }}"

- name: Copy x86_64 grub efi loader
  ansible.builtin.copy:
    src: "{{ role_path }}/files/data/os/x86_64/EFI/BOOT/grubx64.efi"
    dest: "{{ role_path }}/files/data/os/tftp/x86_64/grubx64.efi"
    mode: 0644

- name: Copy aarch64 grub efi loader
  ansible.builtin.copy:
    src: "{{ role_path }}/files/data/os/x86_64/EFI/BOOT/grubaa64.efi"
    dest: "{{ role_path }}/files/data/os/tftp/aarch64/grubaa64.efi"
    mode: 0644

- name: Copy x86_64 initrd
  ansible.builtin.copy:
    src: "{{ role_path }}/files/data/os/x86_64/images/pxeboot/initrd.img"
    dest: "{{ role_path }}/files/data/os/tftp/x86_64/initrd.img"
    mode: 0644

- name: Copy aarch64 initrd
  ansible.builtin.copy:
    src: "{{ role_path }}/files/data/os/aarch64/images/pxeboot/initrd.img"
    dest: "{{ role_path }}/files/data/os/tftp/aarch64/initrd.img"
    mode: 0644

- name: Copy x86_64 vmlinuz
  ansible.builtin.copy:
    src: "{{ role_path }}/files/data/os/x86_64/images/pxeboot/vmlinuz"
    dest: "{{ role_path }}/files/data/os/tftp/x86_64/vmlinuz"
    mode: 0644

- name: Copy aarch64 vmlinuz
  ansible.builtin.copy:
    src: "{{ role_path }}/files/data/os/aarch64/images/pxeboot/vmlinuz"
    dest: "{{ role_path }}/files/data/os/tftp/aarch64/vmlinuz"
    mode: 0644

- name: Start the ephemeral PXE server
  community.docker.docker_compose:
    project_src: "{{ role_path }}/files"
    state: present
    restarted: true
    build: true
